{% extends 'partials/base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/registration/profile.css' %}">
{% endblock %}

{% block title %}Profile Page{% endblock %}

{% block content %}
    {% include 'partials/navbar.html' %}

    <div class="profile-container">
        <div class="profile-header">
            {% if request.user.profile.avatar %}
                <img src="{{ request.user.profile.avatar.url }}" alt="Profile Avatar" class="profile-avatar" width="360" height="360">
            {% else %}
                <img src="{% static 'images/registration/default-avatar.png' %}" alt="Profile Avatar"
                     class="profile-avatar">
            {% endif %}
            <div class="custom-file-upload">
                <input type="file" id="avatar" name="avatar" class="custom-file-input">
            </div>
            <div class="profile-username">{{ request.user.first_name }} {{ request.user.last_name }}</div>
            <div class="profile-email">{{ request.user.email }}</div>
            <div>Member since: {{ request.user.date_joined|date:"F d, Y" }}</div>
        </div>

        <form id="profileForm" method="POST" action="{% url 'account:profile' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="profile-details">
                <div class="detail-item">
                    <span class="detail-label">First Name</span>
                    <span class="detail-value">{{ request.user.first_name|default:"Not Set" }}</span>
                    <input type="text" name="first_name" class="edit-input" value="{{ request.user.first_name }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Name</span>
                    <span class="detail-value">{{ request.user.last_name|default:"Not Set" }}</span>
                    <input type="text" name="last_name" class="edit-input" value="{{ request.user.last_name }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Phone Number</span>
                    <span class="detail-value">{{ request.user.format_phone_number|default:"Not Set" }}</span>
                    <input type="tel" name="phone_number" class="edit-input" id="phone_number"
                           value="{{ request.user.profile.phone_number }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Birth Date</span>
                    <span class="detail-value">{{ request.user.profile.birth_date|default:"Not Set" }}</span>
                    <input type="date" name="birth_date" class="edit-input"
                           value="{{ request.user.profile.birth_date|date:'Y-m-d' }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sex</span>
                    <span class="detail-value">{{ request.user.profile.sex|default:"Not Set" }}</span>
                    <input type="text" name="sex" class="edit-input" value="{{ request.user.profile.sex }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Location</span>
                    <span class="detail-value">{{ request.user.profile.location|default:"Not Set" }}</span>
                    <input type="text" name="location" class="edit-input" value="{{ request.user.profile.location }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status</span>
                    <span class="detail-value">{{ request.user.profile.status|default:"Not Set" }}</span>
                    <input type="text" name="status" class="edit-input" value="{{ request.user.profile.status }}">
                </div>
                <div class="detail-item">
                    <span class="detail-label">Active</span>
                    <div class="status-toggle">
                        <input type="checkbox" id="active-toggle" class="status-input"
                               {% if request.user.is_active %}checked{% endif %} disabled>
                        <label for="active-toggle" class="status-switch">
                            <span class="status-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Two-Factor Authentication</span>
                    <span class="detail-value">
        <div class="switch-container">
            <input type="checkbox" id="2fa-toggle" class="switch-input"
                   {% if request.user.mfa_enabled %}checked{% endif %}>
            <label for="2fa-toggle" class="switch">
                <span class="slider"></span>
            </label>
        </div>
    </span>
                </div>
            </div>
            <button type="submit" id="saveBtn">Save Changes</button>
        </form>
        {% if not request.user.mfa_enabled %}
            <div id="2fa-setup-section" class="2fa-setup">
                <p class="setup-description">
                    Two-Factor Authentication adds an extra layer of security to your account.
                    Follow these steps to enable 2FA:
                </p>

                <div class="qr-code-container">
                    <img src="{{ qrcode }}" alt="2FA QR Code" class="mfa-qr">
                    <p class="qr-instructions">
                        1. Open your authenticator app
                        2. Scan this QR code
                    </p>
                </div>

                <form method="POST" action="{% url 'account:verify_mfa' %}" class="form">
                    {% csrf_token %}
                    <div class="form-group">
                        <input type="text" id="otp_code" name="otp_code" maxlength="6" required
                               class="form-control" placeholder="Enter 6-digit OTP code">
                    </div>
                    <input type="hidden" name="user_id" value="{{ request.user.id }}">
                    <button class="btn-mfa" type="submit">Verify and Enable 2FA</button>
                </form>
            </div>
        {% endif %}

    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggle = document.getElementById('2fa-toggle');
            const setupSection = document.getElementById('2fa-setup-section');

            toggle.addEventListener('change', function () {
                if (this.checked) {
                    if (setupSection) {
                        setupSection.style.display = 'block';
                    }
                } else {
                    window.location.href = "{% url 'account:disable_2fa' %}";
                }
            });
        });


    </script>



    {% include 'partials/footer.html' %}
{% endblock %}